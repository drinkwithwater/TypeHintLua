
const class = require "thlua.class"
const PolyFunction = require "thlua.type.func.PolyFunction"
const TypedFunction = require "thlua.type.func.TypedFunction"

(@let.clazz = import("thlua.type.TypeClass").clazz)

const TypedPolyFunction = class@<clazz.TypedPolyFunction, false>(PolyFunction)

function.open TypedPolyFunction:ctor(...)
	self._fnDict = {} @ Dict(String, clazz.TypedFunction)
end

function TypedPolyFunction:makeFn(vTupleBuilder:clazz.TupleBuilder):Ret(clazz.TypedFunction)
	const nSign = vTupleBuilder:checkTemplateArgSign()
	const nFn = self._fnDict[nSign]
	if not nFn then
		const nResult = self._makerFn(table.unpack(vTupleBuilder:buildPolyArgs())) @ Any
		if TypedFunction.is(nResult) then
			self._fnDict[nSign] = nResult
			return nResult
		else
			error("poly function must return mono-function type but got:"..tostring(nResult))
		end
	else
		return nFn
	end
end

return TypedPolyFunction